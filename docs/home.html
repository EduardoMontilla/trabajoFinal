<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Pagos - Estadísticas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            "blue-light": "#3B82F6",
            "green-light": "#10B981",
            "red-light": "#EF4444",
            "yellow-light": "#F59E0B",
          },
        },
      },
    };
  </script>
</head>

<body class="bg-white font-sans leading-normal tracking-normal">

  <!-- Contenedor Principal -->
  <div class="max-w-6xl mx-auto p-6 bg-white shadow-md rounded-lg mt-10">

    <h1 class="text-3xl font-semibold text-center text-gray-800 mb-6">Lista de Pagos</h1>

    <!-- Cards de Estadísticas -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
      <!-- Card Total Pagos -->
      <div class="bg-gray-50 border-l-4 border-blue-light shadow-sm p-4 flex items-center rounded-lg">
        <div class="text-blue-light">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 10h11M9 21V3m4 18V3m4 7h4m-2 0v7m-6 6h6" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-gray-600">Total Pagos</h3>
          <p id="totalPagos" class="text-xl font-bold text-gray-900">0</p>
        </div>
      </div>
      <!-- Card Pagos a Tiempo -->
      <div class="bg-gray-50 border-l-4 border-green-light shadow-sm p-4 flex items-center rounded-lg">
        <div class="text-green-light">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12h6m2 6h2m-8 0h.01M6 18H4m16-4V8a4 4 0 00-4-4H8a4 4 0 00-4 4v6m4 0h8" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-gray-600">Pagos a Tiempo</h3>
          <p id="pagosATiempo" class="text-xl font-bold text-gray-900">0</p>
        </div>
      </div>
      <!-- Card Pagos Retrasados -->
      <div class="bg-gray-50 border-l-4 border-red-light shadow-sm p-4 flex items-center rounded-lg">
        <div class="text-red-light">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M18.364 5.636l-6.364 6.364m0 0l-6.364 6.364M12 12h8M6 6h.01" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-gray-600">Pagos Retrasados</h3>
          <p id="pagosRetrasados" class="text-xl font-bold text-gray-900">0</p>
        </div>
      </div>
      <!-- Card Pagos Anticipados -->
      <div class="bg-gray-50 border-l-4 border-yellow-light shadow-sm p-4 flex items-center rounded-lg">
        <div class="text-yellow-light">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-gray-600">Pagos Anticipados</h3>
          <p id="pagosAnticipados" class="text-xl font-bold text-gray-900">0</p>
        </div>
      </div>
    </div>

    <!-- Cards de Estadísticas -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
      <!-- Card Total Pagos -->
      <div class="bg-gray-50 border-l-4 border-blue-light shadow-sm p-4 flex items-center rounded-lg">
        <div class="text-blue-light">
          <!-- <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 10h11M9 21V3m4 18V3m4 7h4m-2 0v7m-6 6h6" />
              </svg>-->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-gray-600">Total Cartera</h3>
          <p id="totalCartera" class="text-xl font-bold text-gray-900">0</p>
        </div>
      </div>
      <!-- Card Pagos a Tiempo -->
      <div class="bg-gray-50 border-l-4 border-green-light shadow-sm p-4 flex items-center rounded-lg">
        <div class="text-green-light">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-gray-600">Cliente mas cumplido</h3>
          <p id="pagosATiempo" class="text-xl font-bold text-gray-900">0</p>
        </div>
      </div>
      <!-- Cliente Más Cumplido -->
        <!-- Cliente Más Cumplido -->
    <div class="bg-gray-50 border-l-4 border-green-500 shadow-sm p-4 flex items-center rounded-lg cursor-pointer" onclick="openModal('cumplido')">
      <div class="text-green-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-gray-600">Cliente más cumplido</h3>
        <p id="clienteCumplidoNombre" class="text-xl font-bold text-gray-900">Cargando...</p>
      </div>
    </div>

    <!-- Cliente Más Incumplido -->
    <div class="bg-gray-50 border-l-4 border-red-500 shadow-sm p-4 flex items-center rounded-lg mt-4 cursor-pointer" onclick="openModal('incumplido')">
      <div class="text-red-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-6.364 6.364m0 0l-6.364 6.364M12 12h8M6 6h.01" />
        </svg>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-gray-600">Cliente más incumplido</h3>
        <p id="clienteIncumplidoNombre" class="text-xl font-bold text-gray-900">Cargando...</p>
      </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white p-6 rounded-lg shadow-lg w-80">
        <h3 id="modalTitle" class="text-lg font-bold text-gray-800">Detalles del Cliente</h3>
        <p id="modalContent" class="mt-4 text-gray-600">Cargando...</p>
        <button class="mt-6 w-full bg-blue-500 text-white py-2 rounded-lg" onclick="closeModal()">Cerrar</button>
      </div>
    </div>

    </div>

    <!-- Barra de Filtro -->
    <div class="mb-4">
      <input id="searchInput" type="text"
        class="px-4 py-2 w-80 text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Filtrar por cliente o estado...">
    </div>

    <!-- Tabla de Pagos -->
    <div class="overflow-x-auto overflow-y-auto max-h-96">
      <table class="min-w-full table-auto bg-white rounded-lg shadow-lg">
        <thead class="bg-gray-800 text-white">
          <tr>
            <th class="px-4 py-3 text-left">#</th>
            <th class="px-4 py-3 text-left">Cliente</th>
            <th class="px-4 py-3 text-left">Monto</th>
            <th class="px-4 py-3 text-left">Estado</th>
            <th class="px-4 py-3 text-left">Fecha</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Las filas de la tabla se llenarán dinámicamente -->
        </tbody>
      </table>
    </div>

</body>

<script>

  const apiUrl = 'http://localhost:3000/api/pagos';
  let pagos = [];

  async function cargarPagos() {
    try {
      const response = await fetch(apiUrl);
      const data = await response.json();

      if (response.ok) {
        pagos = data;
        mostrarTabla(pagos);
        actualizarEstadisticas(pagos);
      } else {
        console.error('Error al obtener los pagos:', data);
      }
    } catch (error) {
      console.error('Error de red:', error);
    }
  }

  async function cargarCartera() {
    try {
      const response = await fetch(`${apiUrl}/cartera`);
      const totalCartera = await response.json();
      if (response.ok) {
        document.getElementById('totalCartera').textContent = `$${totalCartera}`;
      } else {
        console.error('Error al obtener los pagos:', data);
      }
    } catch (error) {
      console.error('Error de red:', error);
    }
  }

  async function obtenerCumplimiento() {
    const response = await fetch(`${apiUrl}/cumplimiento`);
    const datos = await response.json();
    return datos;
  }


  function mostrarTabla(pagosFiltrados) {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    pagosFiltrados.forEach((pago) => {
      const tr = document.createElement('tr');
      tr.classList.add('border-b', 'hover:bg-gray-50');
      tr.innerHTML = `
      <td class="px-4 py-2">${pago.id}</td>
      <td class="px-4 py-2">${pago.nombre}</td>
      <td class="px-4 py-2">${pago.cuota}</td>
      <td class="px-4 py-2">${pago.estado}</td>
      <td class="px-4 py-2">${pago.fecha_pago}</td>
    `;
      tableBody.appendChild(tr);
    });
  }

  function actualizarEstadisticas(pagos) {
    const totalPagos = pagos.length;
    const pagosATiempo = pagos.filter(pago => pago.estado.toLowerCase() === 'a tiempo').length;
    const pagosRetrasados = pagos.filter(pago => pago.estado.toLowerCase() === 'retrasado').length;
    const pagosAnticipados = pagos.filter(pago => pago.estado.toLowerCase() === 'anticipado').length;


    document.getElementById('totalPagos').textContent = totalPagos;
    document.getElementById('pagosATiempo').textContent = pagosATiempo;
    document.getElementById('pagosRetrasados').textContent = pagosRetrasados;
    document.getElementById('pagosAnticipados').textContent = pagosAnticipados;
  }

  document.getElementById('searchInput').addEventListener('input', function (e) {
    const query = e.target.value.toLowerCase();
    const pagosFiltrados = pagos.filter(pago =>
      pago.nombre.toLowerCase().includes(query) ||
      pago.estado.toLowerCase().includes(query)
    );
    mostrarTabla(pagosFiltrados);
  });


  cargarCartera();
  window.onload = cargarPagos;






  const apiUrlCumplimiento = 'http://localhost:3000/api/pagos/cumplimiento';

  // Fetch data from the API
  async function fetchData() {
    try {
      const response = await fetch(apiUrlCumplimiento);
      const data = await response.json();

      document.getElementById('clienteCumplidoNombre').textContent = data.clienteMasCumplido.nombre;
      document.getElementById('clienteIncumplidoNombre').textContent = data.clienteMasIncumplido.nombre;

      window.clientes = data; // Store data globally for modal use
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  }

  // Open modal and populate data
  function openModal(type) {
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    if (type === 'cumplido') {
      modalTitle.textContent = 'Cliente Más Cumplido';
      modalContent.innerHTML = `
      <p><strong>Nombre:</strong> ${window.clientes.clienteMasCumplido.nombre}</p>
      <p><strong>Cumplido:</strong> ${window.clientes.clienteMasCumplido.cumplido}</p>
      <p><strong>Incumplido:</strong> ${window.clientes.clienteMasCumplido.incumplido}</p>
    `;
    } else if (type === 'incumplido') {
      modalTitle.textContent = 'Cliente Más Incumplido';
      modalContent.innerHTML = `
      <p><strong>Nombre:</strong> ${window.clientes.clienteMasIncumplido.nombre}</p>
      <p><strong>Cumplido:</strong> ${window.clientes.clienteMasIncumplido.cumplido}</p>
      <p><strong>Incumplido:</strong> ${window.clientes.clienteMasIncumplido.incumplido}</p>
    `;
    }

    modal.classList.remove('hidden');
  }

  // Close modal
  function closeModal() {
    const modal = document.getElementById('modal');
    modal.classList.add('hidden');
  }

  // Initialize
  fetchData();
</script>

</html>